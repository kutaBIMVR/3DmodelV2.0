<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤–å¢™ä¿æ¸©è£…é¥°æ„é€  - ä¸‰ç»´äº¤äº’æ¼”ç¤º</title>
    <!-- Three.js æ ¸å¿ƒåº“ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #0a0e14;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background: linear-gradient(145deg, #0c101a 0%, #151e26 100%);
            overflow-y: auto;
        }

        .page.active {
            display: flex;
        }

        /* ç™»å½•é¡µ */
        .login-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
            background: #2a3846;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .app-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #aad0ff, #7aa5d9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-subtitle {
            color: #9aaec2;
            margin-bottom: 50px;
            font-size: 16px;
            letter-spacing: 4px;
        }

        .login-btn {
            background: linear-gradient(145deg, #2e7eb0, #1e5a7a);
            color: white;
            border: none;
            padding: 16px 50px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 6px;
            box-shadow: 0 8px 0 #0e2a3a, 0 10px 30px rgba(0,160,255,0.3);
            transition: 0.1s;
            cursor: pointer;
            margin-top: 30px;
        }

        .login-btn:active {
            transform: translateY(8px);
            box-shadow: 0 2px 0 #0e2a3a, 0 10px 30px rgba(0,160,255,0.3);
        }

        /* æ‰«ç é¡µ */
        .scan-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
        }

        .scan-header, .list-header, .node-header {
            display: flex;
            align-items: center;
            padding: 10px 0 20px;
            color: white;
        }

        .back-btn {
            font-size: 28px;
            margin-right: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }

        .scan-title {
            font-size: 22px;
            font-weight: 600;
            flex: 1;
        }

        .scan-box {
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            aspect-ratio: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid rgba(100,200,255,0.6);
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .scan-line {
            position: absolute;
            width: 80%;
            height: 2px;
            background: #00f0ff;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 20px #00f0ff;
        }

        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }

        .scan-icon {
            font-size: 80px;
            opacity: 0.8;
        }

        .scan-hint {
            text-align: center;
            color: #aaccff;
            margin: 20px 0 40px;
        }

        .list-btn {
            background: #2a4058;
            padding: 16px;
            border-radius: 30px;
            text-align: center;
            font-weight: bold;
            margin-top: auto;
            cursor: pointer;
            border: 1px solid #4a7a9a;
        }

        /* åˆ—è¡¨é¡µ */
        .list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
        }

        .project-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 20px;
            margin: 12px 0;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: 0.2s;
        }

        .project-card:active {
            background: rgba(80,160,255,0.2);
            border-color: #40a0ff;
        }

        .project-name {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-desc {
            color: #9aabbc;
            font-size: 14px;
            margin-top: 8px;
            padding-left: 30px;
        }

        .project-badge {
            background: #2e5f8a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* ä¸‰ç»´èŠ‚ç‚¹é¡µ - æ ¸å¿ƒ */
        .node-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: #0c101a;
            position: relative;
        }

        .node-header {
            padding: 16px 20px;
            background: rgba(10,20,30,0.8);
            backdrop-filter: blur(10px);
            z-index: 20;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #canvas-container {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background: #0a0e14;
        }

        /* åº•éƒ¨åŠŸèƒ½æ  */
        .action-bar {
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            background: rgba(8,16,24,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid #2a4055;
            z-index: 30;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #9aabbc;
            font-size: 12px;
            padding: 8px 16px;
            border-radius: 30px;
            transition: 0.2s;
            cursor: pointer;
        }

        .action-btn span {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .action-btn.active {
            background: #1e3a5a;
            color: white;
            box-shadow: 0 0 15px #2e7eb0;
        }

        /* å³ä¾§å±‚æ¬¡é¢æ¿ */
        .layers-panel {
            position: absolute;
            right: -280px;
            top: 80px;
            width: 260px;
            background: rgba(10,20,30,0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px 0 0 20px;
            padding: 20px;
            border-left: 3px solid #3a8ac0;
            transition: right 0.3s ease;
            z-index: 100;
            box-shadow: -10px 10px 30px rgba(0,0,0,0.5);
            color: white;
        }

        .layers-panel.show {
            right: 0;
        }

        .layer-item {
            padding: 14px 16px;
            margin: 8px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .layer-item.active {
            background: #2e5a7a;
            border-color: #8ac4ff;
            box-shadow: 0 0 15px #2e7eb0;
        }

        .layer-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .layer-info {
            flex: 1;
        }

        .layer-name {
            font-weight: bold;
        }

        /* æ‹†è£…é¢æ¿ */
        .split-panel {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,20,30,0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 50px;
            display: none;
            gap: 20px;
            z-index: 150;
            border: 1px solid #3a8ac0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }

        .split-btn {
            background: #2a4058;
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 40px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .split-btn:active {
            background: #3a6a8a;
            transform: scale(0.96);
        }

        .split-btn.reset {
            background: #4a3a3a;
        }

        /* æµ‹éªŒé¢æ¿ */
        .quiz-panel {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: rgba(10,20,30,0.98);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 25px;
            border: 2px solid #3a8ac0;
            z-index: 200;
            display: none;
            color: white;
            box-shadow: 0 15px 40px black;
        }

        .quiz-panel.show {
            display: block;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .quiz-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            cursor: pointer;
        }

        .quiz-question {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .quiz-option {
            background: rgba(255,255,255,0.05);
            padding: 14px 18px;
            margin: 10px 0;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .quiz-option.selected {
            background: #2e6a9a;
            border-color: #aae0ff;
            box-shadow: 0 0 20px #2e7eb0;
        }

        .quiz-submit {
            background: #3a8ac0;
            border: none;
            color: white;
            width: 100%;
            padding: 16px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px;
            cursor: pointer;
        }

        #voiceHint {
            position: absolute;
            bottom: 160px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 40px;
            border-left: 4px solid #3a8ac0;
            font-size: 14px;
            z-index: 80;
            color: #b0e0ff;
            pointer-events: none;
        }

        .layer-desc-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 16px 20px;
            border-top: 4px solid #d49b6a;
            z-index: 90;
        }

        #layerTitle {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #ffd966;
        }

        #layerDesc {
            font-size: 14px;
            color: #ddd;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µ -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="logo">ğŸ¢</div>
            <div class="app-title">æ™ºæ…§å·¥åœ°</div>
            <div class="app-subtitle">BIMÂ· å¤–å¢™èŠ‚ç‚¹</div>
            <button id="loginBtn" class="login-btn">è¿›å…¥</button>
        </div>
    </div>

    <!-- æ‰«ç é¡µ -->
    <div id="scanPage" class="page">
        <div class="scan-container">
            <div class="scan-header">
                <div class="back-btn">â†</div>
                <div class="scan-title">æ‰«ææ„ä»¶ç </div>
            </div>
            <div class="scan-box">
                <div class="scan-line"></div>
                <span class="scan-icon">ğŸ“·</span>
            </div>
            <div class="scan-hint">å°†äºŒç»´ç æ”¾å…¥æ¡†å†…ï¼Œè‡ªåŠ¨è¯†åˆ«</div>
            <button id="listBtnFromScan" class="list-btn">æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨ â†’</button>
        </div>
    </div>

    <!-- åˆ—è¡¨é¡µ -->
    <div id="listPage" class="page">
        <div class="list-container">
            <div class="list-header">
                <div id="backToScanFromList" class="back-btn">â†</div>
                <div class="scan-title">å¤–å¢™ä¿æ¸©é¡¹ç›®</div>
            </div>
            <div style="margin: 10px 0 20px; color:#9aaec2;">å…±2ä¸ªèŠ‚ç‚¹</div>
            
            <div id="wallCategory" class="project-card">
                <div class="project-name">
                    <span>ğŸ§±</span> å¤–å¢™ä¿æ¸©è£…é¥°æ„é€ 
                    <span class="project-badge">æ ‡å‡†èŠ‚ç‚¹</span>
                </div>
                <div class="project-desc">
                    åŸºå±‚ Â· ä¿æ¸© Â· æŠ¹ç° Â· é¥°é¢ | å››å±‚æ„é€ 
                </div>
            </div>

            <div id="dryStoneNode" class="project-card">
                <div class="project-name">
                    <span>ğŸª¨</span> å¹²æŒ‚çŸ³æå¹•å¢™
                    <span class="project-badge">å¹•å¢™èŠ‚ç‚¹</span>
                </div>
                <div class="project-desc">
                    é¾™éª¨ Â· ä¿æ¸© Â· çŸ³æ | ç©ºæ°”å±‚æ„é€ 
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button id="goToListBtn" style="display: none;"></button>
            </div>
        </div>
    </div>

    <!-- ä¸‰ç»´èŠ‚ç‚¹é¡µ -->
    <div id="node3DPage" class="page">
        <div class="node-container">
            <div class="node-header">
                <div style="display: flex; align-items: center;">
                    <div id="backToListFromNode" class="back-btn" style="position: static; margin-right: 16px;">â†</div>
                    <div>
                        <div style="font-weight: bold; font-size: 18px;">å¤–å¢™ä¿æ¸©è£…é¥°æ„é€ </div>
                        <div style="font-size: 12px; color: #aad0ff;">ä¸‰ç»´äº¤äº’ / åˆ†å±‚æ‹†è§£</div>
                    </div>
                </div>
            </div>

            <!-- ä¸‰ç»´ç”»å¸ƒå®¹å™¨ -->
            <div id="canvas-container"></div>

            <!-- å±‚æ¬¡æè¿°é¢æ¿ -->
            <div class="layer-desc-panel">
                <div id="layerTitle">ğŸ—ï¸ å¤–å¢™ä¿æ¸©è£…é¥°æ„é€ </div>
                <div id="layerDesc">åŸºå±‚å¢™ä½“ Â· ä¿æ¸©å±‚ Â· æŠ¹ç°å±‚ Â· é¥°é¢å±‚</div>
            </div>

            <!-- è¯­éŸ³/æç¤º -->
            <div id="voiceHint">ğŸ”Š ç‚¹å‡»å±‚æ¬¡é¢æ¿æŸ¥çœ‹è¯¦ç»†æ„é€ </div>

            <!-- å³ä¾§å±‚æ¬¡é¢æ¿ -->
            <div id="layersPanel" class="layers-panel">
                <h3 style="margin-bottom: 20px;">ğŸ“ æ„é€ å±‚æ¬¡</h3>
                <div id="layerBase" class="layer-item active">
                    <span class="layer-color" style="background: #6b7c8b;"></span>
                    <div class="layer-info">
                        <div class="layer-name">åŸºå±‚å¢™ä½“</div>
                        <div style="font-size: 12px; opacity: 0.7;">æ··å‡åœŸ/ç Œä½“</div>
                    </div>
                    <span style="color: #8ac4ff;">â–¶</span>
                </div>
                <div id="layerInsul" class="layer-item">
                    <span class="layer-color" style="background: #3a7ca5;"></span>
                    <div class="layer-info">
                        <div class="layer-name">ä¿æ¸©å±‚</div>
                        <div style="font-size: 12px; opacity: 0.7;">XPSæŒ¤å¡‘æ¿</div>
                    </div>
                    <span style="color: #8ac4ff;">â–¶</span>
                </div>
                <div id="layerRender" class="layer-item">
                    <span class="layer-color" style="background: #b8c2cc;"></span>
                    <div class="layer-info">
                        <div class="layer-name">æŠ¹ç°å±‚</div>
                        <div style="font-size: 12px; opacity: 0.7;">æŠ—è£‚ç ‚æµ†</div>
                    </div>
                    <span style="color: #8ac4ff;">â–¶</span>
                </div>
                <div id="layerFinish" class="layer-item">
                    <span class="layer-color" style="background: #d49b6a;"></span>
                    <div class="layer-info">
                        <div class="layer-name">é¥°é¢å±‚</div>
                        <div style="font-size: 12px; opacity: 0.7;">çœŸçŸ³æ¼†</div>
                    </div>
                    <span style="color: #8ac4ff;">â–¶</span>
                </div>
            </div>

            <!-- æ‹†è£…é¢æ¿ -->
            <div id="splitPanel" class="split-panel">
                <button id="btnSplit" class="split-btn">ğŸ”² æ‹†åˆ†</button>
                <button id="btnAssemble" class="split-btn">â¬› ç»„åˆ</button>
                <button id="btnResetCamera" class="split-btn reset">ğŸ¥ å¤ä½</button>
            </div>

            <!-- æµ‹éªŒé¢æ¿ -->
            <div id="quizPanel" class="quiz-panel">
                <div class="quiz-header">
                    <span>ğŸ“ çŸ¥è¯†æµ‹éªŒ</span>
                    <button id="closeQuiz" class="quiz-close">âœ•</button>
                </div>
                <div class="quiz-question">
                    å¤–å¢™ä¿æ¸©æ„é€ ä¸­ï¼Œèµ·ä¸»è¦ä¿æ¸©éš”çƒ­ä½œç”¨çš„æ˜¯ï¼Ÿ
                </div>
                <div id="quizOptions">
                    <div class="quiz-option" data-idx="0">A. åŸºå±‚å¢™ä½“</div>
                    <div class="quiz-option" data-idx="1">B. ä¿æ¸©å±‚</div>
                    <div class="quiz-option" data-idx="2">C. æŠ¹ç°å±‚</div>
                    <div class="quiz-option" data-idx="3">D. é¥°é¢å±‚</div>
                </div>
                <button id="submitQuiz" class="quiz-submit">æäº¤ç­”æ¡ˆ</button>
                <div id="quizResult" style="text-align: center; margin-top: 10px; min-height: 24px;"></div>
            </div>

            <!-- åº•éƒ¨åŠŸèƒ½æ  -->
            <div class="action-bar">
                <button id="btnDesc" class="action-btn active">
                    <span>ğŸ“‹</span> æ¦‚è¿°
                </button>
                <button id="btnShowLayers" class="action-btn">
                    <span>ğŸ“</span> å±‚æ¬¡
                </button>
                <button id="btnSplitAssemble" class="action-btn">
                    <span>ğŸ”§</span> æ‹†è£…
                </button>
                <button id="btnQuiz" class="action-btn">
                    <span>ğŸ“</span> æµ‹éªŒ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== ä¸‰ç»´æ¨¡å‹ï¼šå¤–å¢™ä¿æ¸©è£…é¥°æ„é€  ====================
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- é¡µé¢è·¯ç”± ---
        const pages = {
            login: document.getElementById('loginPage'),
            scan: document.getElementById('scanPage'),
            list: document.getElementById('listPage'),
            node3d: document.getElementById('node3DPage')
        };

        function showPage(pageId) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageId].classList.add('active');
        }

        // ç™»å½•
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', () => showPage('scan'));
        }

        // æ‰«ç  -> åˆ—è¡¨
        const listBtnFromScan = document.getElementById('listBtnFromScan');
        if (listBtnFromScan) listBtnFromScan.addEventListener('click', () => showPage('list'));
        
        const goToListBtn = document.getElementById('goToListBtn');
        if (goToListBtn) goToListBtn.addEventListener('click', () => showPage('list'));
        
        const backToScanFromList = document.getElementById('backToScanFromList');
        if (backToScanFromList) backToScanFromList.addEventListener('click', () => showPage('scan'));

        // åˆ—è¡¨ -> ä¸‰ç»´èŠ‚ç‚¹
        const wallCategory = document.getElementById('wallCategory');
        const dryStoneNode = document.getElementById('dryStoneNode');
        const backToListFromNode = document.getElementById('backToListFromNode');
        
        function enterNodePage() {
            showPage('node3d');
            initThree();
        }
        
        if (wallCategory) wallCategory.addEventListener('click', enterNodePage);
        if (dryStoneNode) dryStoneNode.addEventListener('click', enterNodePage);
        if (backToListFromNode) backToListFromNode.addEventListener('click', () => showPage('list'));

        // --- ä¸‰ç»´åœºæ™¯åˆå§‹åŒ– ---
        let threeInitialized = false;
        let scene, camera, renderer, labelRenderer, controls, wallGroup;
        let layers = [];
        let baseMesh, insulMesh, renderMesh, finishMesh;
        let origPositions = [];

        function initThree() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (threeInitialized) {
                const container = document.getElementById('canvas-container');
                if (container.children.length === 0) {
                    buildScene();
                }
                return;
            }
            buildScene();
            threeInitialized = true;
        }

        function buildScene() {
            const container = document.getElementById('canvas-container');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°canvas-container');
                return;
            }
            
            container.innerHTML = '';
            
            // --- åœºæ™¯ ---
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0c101a);
            
            // --- ç›¸æœº ---
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(2.5, 1.6, 4.2);
            camera.lookAt(0, 0.6, 0.3);
            
            // --- æ¸²æŸ“å™¨ ---
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            
            // --- CSS2æ¸²æŸ“å™¨ ---
            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(container.clientWidth, container.clientHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0';
            labelRenderer.domElement.style.left = '0';
            labelRenderer.domElement.style.pointerEvents = 'none';
            container.appendChild(labelRenderer.domElement);
            
            // --- æ§åˆ¶å™¨ ---
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.08;
            controls.rotateSpeed = 0.5;
            controls.zoomSpeed = 0.8;
            controls.panSpeed = 0.5;
            controls.target.set(0, 0.6, 0.3);
            controls.enableZoom = true;
            controls.enablePan = true;
            
            // --- ç¯å…‰ ---
            const ambient = new THREE.AmbientLight(0x40506e);
            scene.add(ambient);
            
            const mainLight = new THREE.DirectionalLight(0xffeedd, 1.2);
            mainLight.position.set(2, 3, 4);
            mainLight.castShadow = true;
            mainLight.receiveShadow = true;
            scene.add(mainLight);
            
            const fillLight = new THREE.DirectionalLight(0xaad0ff, 0.6);
            fillLight.position.set(-2, 1, -2);
            scene.add(fillLight);
            
            // è¾…åŠ©ç½‘æ ¼
            const grid = new THREE.GridHelper(8, 20, 0x7a8caa, 0x445566);
            grid.position.y = -0.05;
            scene.add(grid);
            
            // --- åˆ›å»ºæ¨¡å‹ ---
            wallGroup = new THREE.Group();
            
            // 1. åŸºå±‚å¢™ä½“
            const baseMat = new THREE.MeshStandardMaterial({ 
                color: 0x6b7c8b, 
                roughness: 0.7, 
                emissive: new THREE.Color(0x1a1e2a), 
                emissiveIntensity: 0.1 
            });
            const baseGeo = new THREE.BoxGeometry(2.4, 1.6, 0.2);
            baseMesh = new THREE.Mesh(baseGeo, baseMat);
            baseMesh.castShadow = true; 
            baseMesh.receiveShadow = true;
            baseMesh.position.set(0, 0.6, 0);
            baseMesh.userData = { 
                name: 'åŸºå±‚å¢™ä½“', 
                desc: 'æ··å‡åœŸæˆ–ç Œä½“åŸºå±‚ï¼Œåšåº¦200mmï¼Œæ‰¿é‡åŠé˜²ç«éš”ç¦»ã€‚' 
            };
            wallGroup.add(baseMesh);
            
            // 2. ä¿æ¸©å±‚
            const insulMat = new THREE.MeshStandardMaterial({ 
                color: 0x3a7ca5, 
                roughness: 0.6, 
                transparent: true, 
                opacity: 0.85, 
                emissive: new THREE.Color(0x102838) 
            });
            const insulGeo = new THREE.BoxGeometry(2.45, 1.65, 0.15);
            insulMesh = new THREE.Mesh(insulGeo, insulMat);
            insulMesh.castShadow = true; 
            insulMesh.receiveShadow = true;
            insulMesh.position.set(0, 0.6, 0.17);
            insulMesh.userData = { 
                name: 'ä¿æ¸©å±‚', 
                desc: 'æŒ¤å¡‘èšè‹¯æ¿(XPS)ï¼Œåšåº¦50mmï¼Œå¯¼çƒ­ç³»æ•°â‰¤0.03ï¼ŒèŠ‚èƒ½ä¿æ¸©æ ¸å¿ƒå±‚ã€‚' 
            };
            wallGroup.add(insulMesh);
            
            // 3. æŠ¹ç°å±‚
            const renderMat = new THREE.MeshStandardMaterial({ 
                color: 0xb8c2cc, 
                roughness: 0.5, 
                emissive: new THREE.Color(0x282e38) 
            });
            const renderGeo = new THREE.BoxGeometry(2.5, 1.7, 0.06);
            renderMesh = new THREE.Mesh(renderGeo, renderMat);
            renderMesh.castShadow = true; 
            renderMesh.receiveShadow = true;
            renderMesh.position.set(0, 0.6, 0.31);
            renderMesh.userData = { 
                name: 'æŠ¹ç°å±‚', 
                desc: 'æŠ—è£‚ç ‚æµ†å‹å…¥è€ç¢±ç½‘æ ¼å¸ƒï¼Œåšåº¦5mmï¼Œé˜²æ­¢å¼€è£‚ï¼Œå¢å¼ºé˜²æ°´ã€‚' 
            };
            wallGroup.add(renderMesh);
            
            // 4. é¥°é¢å±‚
            const finishMat = new THREE.MeshStandardMaterial({ 
                color: 0xd49b6a, 
                roughness: 0.4, 
                emissive: new THREE.Color(0x3a2a1a), 
                emissiveIntensity: 0.1 
            });
            const finishGeo = new THREE.BoxGeometry(2.52, 1.72, 0.04);
            finishMesh = new THREE.Mesh(finishGeo, finishMat);
            finishMesh.castShadow = true; 
            finishMesh.receiveShadow = true;
            finishMesh.position.set(0, 0.6, 0.38);
            finishMesh.userData = { 
                name: 'é¥°é¢å±‚', 
                desc: 'çœŸçŸ³æ¼†/å½©è‰²é¥°é¢ï¼Œè€å€™æŠ—æ±¡ï¼Œä¸°å¯Œå»ºç­‘å¤–è§‚ã€‚' 
            };
            wallGroup.add(finishMesh);
            
            scene.add(wallGroup);
            
            // æ”¶é›†æ‰€æœ‰å±‚
            layers = [baseMesh, insulMesh, renderMesh, finishMesh];
            origPositions = layers.map(l => l.position.clone());
            
            // æ·»åŠ æ ‡ç­¾
            function createLabel(text, pos, color) {
                const div = document.createElement('div');
                div.textContent = text;
                div.style.background = '#0a0e1ae0';
                div.style.color = 'white';
                div.style.padding = '6px 16px';
                div.style.borderRadius = '30px';
                div.style.border = '2px solid ' + color;
                div.style.fontSize = '14px';
                div.style.fontWeight = 'bold';
                div.style.backdropFilter = 'blur(4px)';
                const label = new CSS2DObject(div);
                label.position.copy(pos);
                return label;
            }
            
            scene.add(createLabel('åŸºå±‚', new THREE.Vector3(-1.0, 1.3, 0), '#8a9aad'));
            scene.add(createLabel('ä¿æ¸©å±‚', new THREE.Vector3(0, 1.4, 0.17), '#3a7ca5'));
            scene.add(createLabel('æŠ¹ç°å±‚', new THREE.Vector3(0.9, 1.4, 0.31), '#b8c2cc'));
            scene.add(createLabel('é¥°é¢å±‚', new THREE.Vector3(1.0, 1.4, 0.38), '#d49b6a'));
            
            // --- åˆå§‹åŒ–ç•Œé¢çŠ¶æ€ ---
            const layersPanel = document.getElementById('layersPanel');
            const splitPanel = document.getElementById('splitPanel');
            
            if (layersPanel) layersPanel.classList.remove('show');
            if (splitPanel) splitPanel.style.display = 'none';
            
            // --- å››å¤§åŠŸèƒ½æŒ‰é’®äº¤äº’ ---
            const btnDesc = document.getElementById('btnDesc');
            const btnShowLayers = document.getElementById('btnShowLayers');
            const btnSplitAssemble = document.getElementById('btnSplitAssemble');
            const btnQuiz = document.getElementById('btnQuiz');
            
            if (btnDesc) {
                btnDesc.addEventListener('click', () => {
                    setActiveAction('btnDesc');
                    if (layersPanel) layersPanel.classList.remove('show');
                    if (splitPanel) splitPanel.style.display = 'none';
                    document.getElementById('quizPanel')?.classList.remove('show');
                    resetLayerTransparency();
                    document.getElementById('layerTitle').innerHTML = 'ğŸ—ï¸ å¤–å¢™ä¿æ¸©è£…é¥°æ„é€ ';
                    document.getElementById('layerDesc').innerHTML = 'åŸºå±‚å¢™ä½“ Â· ä¿æ¸©å±‚ Â· æŠ¹ç°å±‚ Â· é¥°é¢å±‚';
                });
            }
            
            if (btnShowLayers) {
                btnShowLayers.addEventListener('click', () => {
                    setActiveAction('btnShowLayers');
                    if (layersPanel) {
                        layersPanel.classList.add('show');
                        splitPanel.style.display = 'none';
                    }
                    document.getElementById('quizPanel')?.classList.remove('show');
                    setActiveLayer('base');
                    setActiveLayerBtn('layerBase');
                });
            }
            
            if (btnSplitAssemble) {
                btnSplitAssemble.addEventListener('click', () => {
                    setActiveAction('btnSplitAssemble');
                    if (splitPanel) {
                        splitPanel.style.display = 'flex';
                        layersPanel.classList.remove('show');
                    }
                    document.getElementById('quizPanel')?.classList.remove('show');
                    resetLayerTransparency();
                });
            }
            
            if (btnQuiz) {
                btnQuiz.addEventListener('click', () => {
                    setActiveAction('btnQuiz');
                    document.getElementById('quizPanel')?.classList.add('show');
                    layersPanel.classList.remove('show');
                    splitPanel.style.display = 'none';
                });
            }
            
            function setActiveAction(id) {
                [btnDesc, btnShowLayers, btnSplitAssemble, btnQuiz].forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });
                const activeBtn = document.getElementById(id);
                if (activeBtn) activeBtn.classList.add('active');
            }
            
            // --- å±‚æ¬¡æŒ‰é’®äº‹ä»¶ ---
            const layerBase = document.getElementById('layerBase');
            const layerInsul = document.getElementById('layerInsul');
            const layerRender = document.getElementById('layerRender');
            const layerFinish = document.getElementById('layerFinish');
            
            if (layerBase) {
                layerBase.addEventListener('click', () => {
                    setActiveLayer('base');
                    setActiveLayerBtn('layerBase');
                    document.getElementById('voiceHint').innerHTML = 'ğŸ”Š è¯­éŸ³è®²è§£ï¼šåŸºå±‚å¢™ä½“ï¼Œæ‰¿é‡ç»“æ„ï¼Œé˜²ç«éš”ç¦»å±‚';
                });
            }
            
            if (layerInsul) {
                layerInsul.addEventListener('click', () => {
                    setActiveLayer('insul');
                    setActiveLayerBtn('layerInsul');
                    document.getElementById('voiceHint').innerHTML = 'ğŸ”Š è¯­éŸ³è®²è§£ï¼šä¿æ¸©å±‚ï¼ŒXPSæŒ¤å¡‘æ¿ï¼Œå¯¼çƒ­ç³»æ•°â‰¤0.03';
                });
            }
            
            if (layerRender) {
                layerRender.addEventListener('click', () => {
                    setActiveLayer('render');
                    setActiveLayerBtn('layerRender');
                    document.getElementById('voiceHint').innerHTML = 'ğŸ”Š è¯­éŸ³è®²è§£ï¼šæŠ¹ç°å±‚ï¼ŒæŠ—è£‚ç ‚æµ†ï¼Œè€ç¢±ç½‘æ ¼å¸ƒ';
                });
            }
            
            if (layerFinish) {
                layerFinish.addEventListener('click', () => {
                    setActiveLayer('finish');
                    setActiveLayerBtn('layerFinish');
                    document.getElementById('voiceHint').innerHTML = 'ğŸ”Š è¯­éŸ³è®²è§£ï¼šé¥°é¢å±‚ï¼ŒçœŸçŸ³æ¼†ï¼Œè€å€™æŠ—æ±¡';
                });
            }
            
            function setActiveLayerBtn(id) {
                ['layerBase','layerInsul','layerRender','layerFinish'].forEach(i => {
                    const btn = document.getElementById(i);
                    if (btn) btn.classList.remove('active');
                });
                const activeBtn = document.getElementById(id);
                if (activeBtn) activeBtn.classList.add('active');
            }
            
            // åŠé€æ˜é€»è¾‘
            function setActiveLayer(layerName) {
                resetLayerTransparency();
                if (layerName === 'base') {
                    if (baseMesh) baseMesh.material.emissive.setHex(0x333333);
                    [insulMesh, renderMesh, finishMesh].forEach(l => { 
                        if (l) {
                            l.material.transparent = true; 
                            l.material.opacity = 0.25;
                        }
                    });
                    document.getElementById('layerTitle').innerHTML = 'ğŸ§± åŸºå±‚å¢™ä½“';
                    document.getElementById('layerDesc').innerHTML = baseMesh?.userData.desc || '';
                } else if (layerName === 'insul') {
                    if (insulMesh) insulMesh.material.emissive.setHex(0x333333);
                    [baseMesh, renderMesh, finishMesh].forEach(l => { 
                        if (l) {
                            l.material.transparent = true; 
                            l.material.opacity = 0.25;
                        }
                    });
                    document.getElementById('layerTitle').innerHTML = 'ğŸŸ« ä¿æ¸©å±‚';
                    document.getElementById('layerDesc').innerHTML = insulMesh?.userData.desc || '';
                } else if (layerName === 'render') {
                    if (renderMesh) renderMesh.material.emissive.setHex(0x333333);
                    [baseMesh, insulMesh, finishMesh].forEach(l => { 
                        if (l) {
                            l.material.transparent = true; 
                            l.material.opacity = 0.25;
                        }
                    });
                    document.getElementById('layerTitle').innerHTML = 'âšª æŠ¹ç°å±‚';
                    document.getElementById('layerDesc').innerHTML = renderMesh?.userData.desc || '';
                } else if (layerName === 'finish') {
                    if (finishMesh) finishMesh.material.emissive.setHex(0x333333);
                    [baseMesh, insulMesh, renderMesh].forEach(l => { 
                        if (l) {
                            l.material.transparent = true; 
                            l.material.opacity = 0.25;
                        }
                    });
                    document.getElementById('layerTitle').innerHTML = 'ğŸ¨ é¥°é¢å±‚';
                    document.getElementById('layerDesc').innerHTML = finishMesh?.userData.desc || '';
                }
            }
            
            function resetLayerTransparency() {
                layers.forEach(l => { 
                    if (l) {
                        l.material.transparent = false; 
                        l.material.opacity = 1;
                        l.material.emissive.setHex(0x000000);
                    }
                });
            }
            
            // --- æ‹†è£…åŠŸèƒ½ ---
            const btnSplit = document.getElementById('btnSplit');
            const btnAssemble = document.getElementById('btnAssemble');
            const btnResetCamera = document.getElementById('btnResetCamera');
            
            if (btnSplit) {
                btnSplit.addEventListener('click', () => {
                    if (baseMesh) baseMesh.position.z = origPositions[0]?.z || 0;
                    if (insulMesh) insulMesh.position.z = (origPositions[1]?.z || 0) + 0.4;
                    if (renderMesh) renderMesh.position.z = (origPositions[2]?.z || 0) + 0.8;
                    if (finishMesh) finishMesh.position.z = (origPositions[3]?.z || 0) + 1.2;
                });
            }
            
            if (btnAssemble) {
                btnAssemble.addEventListener('click', () => {
                    layers.forEach((l, idx) => {
                        if (l && origPositions[idx]) l.position.copy(origPositions[idx]);
                    });
                });
            }
            
            if (btnResetCamera) {
                btnResetCamera.addEventListener('click', () => {
                    if (camera) camera.position.set(2.5, 1.6, 4.2);
                    if (controls) controls.target.set(0, 0.6, 0.3);
                    if (controls) controls.update();
                });
            }
            
            // é»˜è®¤æ¿€æ´»åŸºå±‚
            setActiveLayer('base');
            setActiveLayerBtn('layerBase');
            
            // åŠ¨ç”»å¾ªç¯
            function animate() {
                requestAnimationFrame(animate);
                if (controls) controls.update();
                if (renderer && scene && camera) renderer.render(scene, camera);
                if (labelRenderer && scene && camera) labelRenderer.render(scene, camera);
            }
            animate();
            
            // çª—å£è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                const w = container.clientWidth;
                const h = container.clientHeight;
                if (camera) {
                    camera.aspect = w / h;
                    camera.updateProjectionMatrix();
                }
                if (renderer) renderer.setSize(w, h);
                if (labelRenderer) labelRenderer.setSize(w, h);
            });
        }

        // --- æµ‹éªŒé€»è¾‘ ---
        const closeQuiz = document.getElementById('closeQuiz');
        if (closeQuiz) {
            closeQuiz.addEventListener('click', () => {
                document.getElementById('quizPanel').classList.remove('show');
            });
        }
        
        const opts = document.querySelectorAll('#quizOptions .quiz-option');
        let selectedIdx = null;
        
        opts.forEach(opt => {
            opt.addEventListener('click', function() {
                opts.forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedIdx = parseInt(this.dataset.idx);
            });
        });
        
        const submitQuiz = document.getElementById('submitQuiz');
        if (submitQuiz) {
            submitQuiz.addEventListener('click', () => {
                const res = document.getElementById('quizResult');
                if (res) {
                    if (selectedIdx === 1) {
                        res.innerHTML = 'âœ… å›ç­”æ­£ç¡®ï¼ä¿æ¸©å±‚èµ·ä¸»è¦ä¿æ¸©éš”çƒ­ä½œç”¨ã€‚';
                        res.style.color = '#88ff88';
                    } else {
                        res.innerHTML = 'âŒ é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯Bï¼Œä¿æ¸©å±‚ã€‚';
                        res.style.color = '#ff8888';
                    }
                }
            });
        }
    </script>
</body>
</html>