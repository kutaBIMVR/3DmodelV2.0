<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¹²æŒ‚çŸ³æèŠ‚ç‚¹æ„é€  Â· æ™ºèƒ½æ•™å­¦æ¼”ç¤º</title>
    <!-- å¼•å…¥Three.jsæ ¸å¿ƒåº“åŠé™„åŠ ç»„ä»¶ (ä½¿ç”¨ç¨³å®šç‰ˆæœ¬) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            overflow: hidden;
            background-color: #0a0e14;
            color: white;
        }

        /* ä¸»ç•Œé¢å¸ƒå±€ï¼šå·¦ä¾§æ§åˆ¶åŒº + å³ä¾§æ¨¡å‹åŒº */
        #app {
            display: flex;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
        }

        /* å³ä¾§æ¨¡å‹å®¹å™¨å æ®å…¨çª—å£ï¼Œå·¦ä¾§é¢æ¿æµ®åŠ¨åœ¨ä¸Šå±‚ */
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 20% 30%, #1a1e2a, #0a0c12);
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ï¼šåŠé€æ˜æ‚¬æµ®ï¼Œä¸å ç”¨æ¨¡å‹ç‚¹å‡» */
        #control-panel {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 300px;
            background: rgba(10, 15, 25, 0.75);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 24px 20px;
            color: #fff;
            border: 1px solid rgba(100, 180, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            z-index: 300;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            pointer-events: auto;
            scrollbar-width: thin;
            scrollbar-color: #3a7ca5 #1e2632;
        }

        #control-panel::-webkit-scrollbar {
            width: 5px;
        }
        #control-panel::-webkit-scrollbar-thumb {
            background: #3a7ca5;
            border-radius: 10px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffd966;
            border-bottom: 2px solid #3a7ca5;
            padding-bottom: 12px;
        }

        .subtitle {
            color: #b0d0ff;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 16px;
            border-left: 5px solid #ffaa00;
        }

        /* å±‚æ¬¡æŒ‰é’®ç»„ */
        .section-title {
            font-size: 16px;
            margin: 18px 0 8px 0;
            color: #aaddff;
            border-left: 4px solid #ffaa00;
            padding-left: 10px;
        }

        .layer-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .layer-btn {
            background: rgba(30, 40, 60, 0.9);
            border: 1px solid #4a6c8f;
            color: #eef5ff;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .layer-btn:hover {
            background: #2a405c;
            border-color: #ffaa00;
            transform: translateY(-2px);
        }

        .layer-btn.active {
            background: #ffaa00;
            color: #1a1e2a;
            border-color: #ffffff;
            font-weight: bold;
            box-shadow: 0 0 15px #ffaa00aa;
        }

        .btn-icon {
            font-size: 16px;
        }

        /* æ‹†è£…æ§åˆ¶ç»„ */
        .assembly-group {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            justify-content: space-between;
        }

        .action-btn {
            background: #2e4b6a;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 30px;
            font-size: 14px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            border-bottom: 3px solid #0e2a3b;
        }

        .action-btn:hover {
            background: #3e6a8c;
            border-bottom-color: #ffaa00;
        }

        /* è¯•é¢˜åŒº */
        .quiz-area {
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 18px;
            margin-top: 25px;
            border: 1px solid #5f9ea0;
        }

        .question {
            font-size: 15px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #ffe28c;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .option-item {
            background: rgba(50,70,90,0.7);
            padding: 10px 14px;
            border-radius: 20px;
            border: 1px solid #557799;
            cursor: pointer;
            transition: 0.1s;
            font-size: 14px;
        }

        .option-item:hover {
            background: #3e6885;
            border-color: #ffaa00;
        }

        .option-item.selected {
            background: #0a7e8c;
            border: 2px solid #ffd966;
        }

        .feedback {
            margin-top: 12px;
            font-style: italic;
            padding: 10px;
            border-radius: 12px;
            background: rgba(0,0,0,0.5);
            color: #cce6ff;
            border-left: 6px solid #ffaa00;
        }

        /* çŠ¶æ€æ¡ */
        #status-bar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 20, 30, 0.85);
            backdrop-filter: blur(8px);
            padding: 14px 30px;
            border-radius: 50px;
            border: 1px solid #3a7ca5;
            box-shadow: 0 0 25px #0055aa40;
            color: #b8f2ff;
            font-size: 15px;
            z-index: 350;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 1px;
            border-bottom: 4px solid #0ff;
        }

        #voice-hint {
            position: absolute;
            bottom: 120px;
            right: 30px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 13px;
            color: #ffcc99;
            border: 1px solid #ffaa00;
            z-index: 400;
            pointer-events: none;
        }

        /* å³ä¸‹æ–¹å°æç¤º */
        .hint-note {
            position: absolute;
            bottom: 130px;
            left: 350px;
            color: rgba(220,240,255,0.7);
            font-size: 12px;
            background: rgba(0,0,0,0.4);
            padding: 6px 16px;
            border-radius: 20px;
            pointer-events: none;
            border: 1px dashed #aaddff;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <!-- Three.jsç”»å¸ƒå°†æ’å…¥æ­¤å¤„ -->
    </div>

    <!-- å·¦ä¾§æµ®åŠ¨æ§åˆ¶é¢æ¿ -->
    <div id="control-panel">
        <h2>ğŸ§± å¹²æŒ‚çŸ³æèŠ‚ç‚¹ Â· æ„é€ è®¤çŸ¥</h2>
        <div class="subtitle">
            ğŸ“ æ„ä»¶æŒ‰Maxå‘½ååŒ¹é…ï¼šåŸºå±‚å¢™ä½“ã€é¢„åŸ‹ä»¶ã€ç«–å‘é¾™éª¨ã€æ¨ªå‘é¾™éª¨ã€ä¿æ¸©å±‚ã€çŸ³ææŒ‚ä»¶ã€çŸ³æé¢æ¿ã€å¯†å°èƒ¶ã€‚<br>
            ğŸ¯ ç‚¹å‡»å±‚æ¬¡é«˜äº®æ˜¾ç¤ºï¼Œå…¶ä»–åŠé€æ˜ï¼›å†æ¬¡ç‚¹å‡»å–æ¶ˆã€‚â­ ç‚¹å‡»æŒ‰é’®åå³è¯­éŸ³è®²è§£ã€‚
        </div>

        <!-- å±‚æ¬¡æ„é€ æŒ‰é’®åŒº (æŒ‰èŠ‚ç‚¹ç±»å‹é¡ºåº) -->
        <div class="section-title">ğŸ” æ„é€ å±•ç¤º (ç‚¹å‡»é«˜äº®/è¯­éŸ³)</div>
        <div id="layer-buttons-container" class="layer-buttons">
            <!-- åŠ¨æ€æ³¨å…¥JSç”Ÿæˆï¼Œä¹Ÿå¯é™æ€å†™å¥½ä½†ä¸ºäº†æ˜ å°„é¢œè‰²/åç§°åŠ¨æ€ç”Ÿæˆæ›´çµæ´»ã€‚æ­¤å¤„ç”¨JSå¡«å……ï¼Œä½†å…ˆå†™é™æ€å ä½ï¼›æ··åˆæ–¹å¼ã€‚ -->
        </div>

        <!-- æ‹†è£…æ§åˆ¶åŒº -->
        <div class="section-title">ğŸ§© æ„é€ æ‹†è£…</div>
        <div class="assembly-group">
            <button id="btn-split" class="action-btn"><span class="btn-icon">ğŸ”²</span> æ‹†åˆ†</button>
            <button id="btn-assemble" class="action-btn"><span class="btn-icon">ğŸ”¹</span> ä¸€é”®ç»„è£…</button>
        </div>

        <!-- å›¾æ–‡è¯´æ˜åŒºï¼šæ„é€ è¯´æ˜åŠ¨æ€æ˜¾ç¤º -->
        <div class="section-title">ğŸ“˜ å›¾æ–‡è¯´æ˜</div>
        <div id="construction-desc" style="background: #0e1a26; padding: 16px; border-radius: 16px; border-left: 8px solid #6b7c8b; margin-bottom: 5px;">
            <strong style="color:#ffd966;">åŸºå±‚å¢™ä½“</strong>ï¼šç°è‰²ï¼Œå»ºç­‘ç»“æ„åŸºç¡€ã€‚<br>
            <span id="extra-desc">ç‚¹å‡»å±‚æ¬¡æŸ¥çœ‹è¯¦ç»†æ„é€ è¯´æ˜</span>
        </div>

        <!-- è¯•é¢˜è€ƒæ ¸åŒºåŸŸ -->
        <div class="quiz-area">
            <div class="question">ğŸ“Œ è¯•é¢˜ï¼šå¹²æŒ‚çŸ³æèŠ‚ç‚¹ä¸­ï¼Œä¸»è¦æ‰¿å—è·è½½å¹¶å°†åŠ›ä¼ é€’åˆ°ä¸»ä½“çš„å…³é”®è¿æ¥æ„ä»¶æ˜¯ï¼Ÿ</div>
            <div id="options-container" class="options">
                <div class="option-item" data-index="0">A. çŸ³æé¢æ¿</div>
                <div class="option-item" data-index="1">B. ç«–å‘é¾™éª¨</div>
                <div class="option-item" data-index="2">C. çŸ³ææŒ‚ä»¶</div>
                <div class="option-item" data-index="3">D. å¯†å°èƒ¶</div>
            </div>
            <div id="quiz-feedback" class="feedback">ğŸ’¡ è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</div>
        </div>
        <p style="font-size: 12px; color: #aaa; text-align: right; margin-top: 8px;">è¯­éŸ³è®²è§£åŸºäºWeb Speech API</p>
    </div>

    <div id="status-bar">
        <span id="status-icon">âš™ï¸</span> <span id="status-text">æ¨¡å‹åŠ è½½ä¸­...</span>
    </div>
    <div id="voice-hint">ğŸ”Š ç‚¹å‡»å±‚æ¬¡æŒ‰é’®è‡ªåŠ¨è¯­éŸ³è®²è§£</div>
    <div class="hint-note">ğŸ–±ï¸ æ‹–æ‹½æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®å¹³ç§» | è‡ªåŠ¨æ—‹è½¬(å¯æ‹–åŠ¨åæš‚åœ)</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        // ---------- 1. åœºæ™¯åŸºç¡€è®¾ç½® ----------
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0e14); // æ·±ç°è“è°ƒ

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(6, 4, 12);
        camera.lookAt(0, 1, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // æ§åˆ¶å™¨
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.06;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.2;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.target.set(0, 1.2, 0);
        controls.maxDistance = 300;
        controls.minDistance = 2;

        // ç¯å…‰ç³»ç»Ÿ
        const ambientLight = new THREE.AmbientLight(0x404c63);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffeedd, 1.2);
        mainLight.position.set(3, 5, 6);
        mainLight.castShadow = true;
        mainLight.receiveShadow = true;
        mainLight.shadow.mapSize.width = 1024;
        mainLight.shadow.mapSize.height = 1024;
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0xcce0ff, 0.6);
        fillLight.position.set(-4, 2, -5);
        scene.add(fillLight);

        const backLight = new THREE.PointLight(0x6688aa, 0.3);
        backLight.position.set(0, 2, 10);
        scene.add(backLight);

        // è¾…åŠ©å…ƒç´ ï¼šåœ°é¢ç½‘æ ¼ + è½´çº¿ (ç¨æš—)
        const gridHelper = new THREE.GridHelper(20, 20, 0x5a7a9a, 0x334455);
        scene.add(gridHelper);
        const axesHelper = new THREE.AxesHelper(8);
        scene.add(axesHelper);

        // å­˜å‚¨æ¨¡å‹å’ŒèŠ‚ç‚¹åˆ†ç»„
        let currentModel = null;
        // æ„ä»¶æ˜ å°„ï¼škeyä¸ºä¸­æ–‡å(å¯¹åº”Maxå‘½åå…³é”®è¯)ï¼Œvalueä¸ºå¯¹è±¡æ•°ç»„(meshåˆ—è¡¨)
        const layerMeshesMap = new Map();
        // é¢„å®šä¹‰8ä¸ªå±‚æ¬¡ï¼Œä¸é¢œè‰²å»ºè®®å¯¹åº”ï¼ŒåŒæ—¶ç”¨äºUI
        const layerConfig = [
            { name: 'åŸºå±‚å¢™ä½“', keyword: 'åŸºå±‚_å¢™ä½“', color: '#6b7c8b', emissive: '#2a3a4a' },
            { name: 'é¢„åŸ‹ä»¶', keyword: 'é¢„åŸ‹ä»¶', color: '#cccccc', emissive: '#888888' },
            { name: 'ç«–å‘é¾™éª¨', keyword: 'é¾™éª¨_ç«–å‘', color: '#9aa9b9', emissive: '#5f6f7f' },
            { name: 'æ¨ªå‘é¾™éª¨', keyword: 'é¾™éª¨_æ¨ªå‘', color: '#9aa9b9', emissive: '#5f6f7f' },
            { name: 'ä¿æ¸©å±‚', keyword: 'ä¿æ¸©_æŒ¤å¡‘æ¿', color: '#3a7ca5', emissive: '#1e4a6a' },
            { name: 'çŸ³ææŒ‚ä»¶', keyword: 'æŒ‚ä»¶', color: '#b0b0b0', emissive: '#7a7a7a' },
            { name: 'çŸ³æé¢æ¿', keyword: 'çŸ³æ_é¢æ¿', color: '#c0a080', emissive: '#8b6b4b' },
            { name: 'å¯†å°èƒ¶', keyword: 'å¯†å°èƒ¶', color: '#505050', emissive: '#303030' }
        ];

        // å­˜å‚¨åŸå§‹æè´¨ä»¥ä¾¿æ¢å¤
        const originalMaterials = new WeakMap();

        // ---------- çŠ¶æ€æ›´æ–°UI ----------
        function setStatus(msg, isError = false) {
            const el = document.getElementById('status-text');
            const icon = document.getElementById('status-icon');
            if (el) el.innerText = msg;
            if (icon) icon.innerText = isError ? 'âŒ' : 'âš™ï¸';
            const bar = document.getElementById('status-bar');
            if (bar) {
                bar.style.borderBottomColor = isError ? '#ff4444' : '#0ff';
            }
        }

        // ---------- è¯­éŸ³è®²è§£ ----------
        function speakLayerInfo(layerName) {
            if (!window.speechSynthesis) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³');
                return;
            }
            let detail = '';
            const cfg = layerConfig.find(l => l.name === layerName);
            switch(layerName) {
                case 'åŸºå±‚å¢™ä½“': detail = 'åŸºå±‚å¢™ä½“ï¼Œé€šå¸¸ä¸ºæ··å‡åœŸæˆ–ç Œå—ï¼Œç°è‰²ï¼Œæ˜¯éª¨æ¶çš„æ‰¿è½½åŸºç¡€ã€‚'; break;
                case 'é¢„åŸ‹ä»¶': detail = 'é¢„åŸ‹ä»¶ï¼Œé‡‘å±åˆ¶ï¼Œæå‰åŸ‹è®¾äºå¢™ä½“ï¼Œç”¨äºè¿æ¥é¾™éª¨ã€‚'; break;
                case 'ç«–å‘é¾™éª¨': detail = 'ç«–å‘é¾™éª¨ï¼Œä¸»è¦å—åŠ›æ„ä»¶ï¼Œä¸é¢„åŸ‹ä»¶å›ºå®šã€‚'; break;
                case 'æ¨ªå‘é¾™éª¨': detail = 'æ¨ªå‘é¾™éª¨ï¼Œæ°´å¹³æ”¯æ’‘ï¼Œå¢å¼ºç¨³å®šæ€§ã€‚'; break;
                case 'ä¿æ¸©å±‚': detail = 'ä¿æ¸©å±‚ï¼ŒæŒ¤å¡‘æ¿ï¼Œè“è‰²ï¼Œéš”çƒ­èŠ‚èƒ½ã€‚'; break;
                case 'çŸ³ææŒ‚ä»¶': detail = 'çŸ³ææŒ‚ä»¶ï¼Œä¸é”ˆé’¢ç­‰é‡‘å±ï¼Œè¿æ¥çŸ³æä¸é¾™éª¨ã€‚'; break;
                case 'çŸ³æé¢æ¿': detail = 'çŸ³æé¢æ¿ï¼ŒèŠ±å²—å²©è´¨æ„Ÿï¼Œè£…é¥°é¢å±‚ã€‚'; break;
                case 'å¯†å°èƒ¶': detail = 'å¯†å°èƒ¶ï¼Œé»‘è‰²ï¼Œå¡«ç¼é˜²æ°´ã€‚'; break;
                default: detail = layerName;
            }
            const utterance = new SpeechSynthesisUtterance(`${layerName}ï¼š${detail}`);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            window.speechSynthesis.cancel(); // é¿å…é‡å 
            window.speechSynthesis.speak(utterance);
        }

        // ---------- æ›´æ–°å›¾æ–‡è¯´æ˜åŒº ----------
        function updateDescription(layerName) {
            const descDiv = document.getElementById('extra-desc');
            const titleStrong = document.querySelector('#construction-desc strong');
            const cfg = layerConfig.find(l => l.name === layerName);
            if (cfg) {
                titleStrong.innerText = cfg.name;
                titleStrong.style.color = '#ffd966';
                let colorDesc = '';
                switch(cfg.name) {
                    case 'åŸºå±‚å¢™ä½“': colorDesc = 'ç°è‰² #6b7c8b'; break;
                    case 'é¢„åŸ‹ä»¶': colorDesc = 'é‡‘å±è‰² #cccccc'; break;
                    case 'ç«–å‘é¾™éª¨': colorDesc = 'é“¶è‰² #9aa9b9'; break;
                    case 'æ¨ªå‘é¾™éª¨': colorDesc = 'é“¶è‰² #9aa9b9'; break;
                    case 'ä¿æ¸©å±‚': colorDesc = 'è“è‰² #3a7ca5'; break;
                    case 'çŸ³ææŒ‚ä»¶': colorDesc = 'é‡‘å±è‰² #b0b0b0'; break;
                    case 'çŸ³æé¢æ¿': colorDesc = 'èŠ±å²—å²©è‰² #c0a080'; break;
                    case 'å¯†å°èƒ¶': colorDesc = 'é»‘è‰² #505050'; break;
                }
                descDiv.innerHTML = `é¢œè‰²å»ºè®®ï¼š${colorDesc}<br>åŠŸèƒ½ï¼š${detailText(cfg.name)}`;
            }
        }

        function detailText(name) {
            const map = {
                'åŸºå±‚å¢™ä½“': 'ç»“æ„åŸºåº•ï¼Œæ‰¿é‡åŠä¼ åŠ›ã€‚',
                'é¢„åŸ‹ä»¶': 'ä¸å¢™ä½“é”šå›ºï¼Œè¿æ¥é¾™éª¨çš„é‡‘å±ä»¶ã€‚',
                'ç«–å‘é¾™éª¨': 'å‚ç›´ä¸»é¾™éª¨ï¼Œè°ƒèŠ‚å¹³æ•´åº¦ï¼Œæ‰¿å—é£è·è½½ã€‚',
                'æ¨ªå‘é¾™éª¨': 'æ°´å¹³æ¬¡é¾™éª¨ï¼Œå¢åŠ æ•´ä½“æ€§ã€‚',
                'ä¿æ¸©å±‚': 'ç²˜è´´æˆ–é”šå›ºäºå¢™ä½“ï¼Œä¿æ¸©éš”çƒ­ã€‚',
                'çŸ³ææŒ‚ä»¶': 'å¯è°ƒæŒ‚ä»¶ï¼Œå›ºå®šçŸ³ææ¿å—ã€‚',
                'çŸ³æé¢æ¿': 'è£…é¥°çŸ³æï¼Œé€šè¿‡æŒ‚ä»¶å®‰è£…ã€‚',
                'å¯†å°èƒ¶': 'åµŒç¼ææ–™ï¼Œé˜²æ°´å¯†å°ã€‚'
            };
            return map[name] || '';
        }

        // ---------- é«˜äº®/åŠé€æ˜é€»è¾‘ ----------
        let currentActiveLayer = null;

        function highlightLayer(layerName) {
            // å…ˆæ¢å¤æ‰€æœ‰æè´¨ä¸ºä¸åŠé€æ˜
            resetAllOpacity();
            
            if (!layerName) return;
            
            const meshes = layerMeshesMap.get(layerName) || [];
            if (meshes.length === 0) {
                setStatus(`æœªæ‰¾åˆ°: ${layerName}`, true);
                return;
            }

            // éå†æ‰€æœ‰æ„ä»¶ï¼šå±äºè¯¥layerçš„ä¸é€æ˜ï¼Œå…¶ä»–åŠé€æ˜
            scene.traverse(obj => {
                if (obj.isMesh) {
                    // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡layeré›†åˆé‡Œ
                    const isTarget = meshes.includes(obj);
                    if (!isTarget) {
                        // å…¶ä»–meshè®¾ä¸ºåŠé€æ˜
                        if (obj.material) {
                            const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
                            mats.forEach(mat => {
                                if (mat) {
                                    mat.opacity = 0.2;
                                    mat.transparent = true;
                                }
                            });
                        }
                    } else {
                        // ç›®æ ‡meshç¡®ä¿ä¸é€æ˜
                        if (obj.material) {
                            const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
                            mats.forEach(mat => {
                                if (mat) {
                                    mat.opacity = 1.0;
                                    mat.transparent = false;
                                }
                            });
                        }
                    }
                }
            });
            currentActiveLayer = layerName;
            setStatus(`é«˜äº®: ${layerName}`);
            updateDescription(layerName);
        }

        function resetAllOpacity() {
            scene.traverse(obj => {
                if (obj.isMesh && obj.material) {
                    const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
                    mats.forEach(mat => {
                        if (mat) {
                            mat.opacity = 1.0;
                            mat.transparent = false;
                        }
                    });
                }
            });
            currentActiveLayer = null;
        }

        // ---------- æ‹†åˆ†/ç»„è£… (ä½ç§»æ‹†åˆ†) ----------
        let isSplit = false;
        const splitOffsets = {
            'åŸºå±‚å¢™ä½“': new THREE.Vector3(0,0,0),
            'é¢„åŸ‹ä»¶': new THREE.Vector3(0.6,0,0.3),
            'ç«–å‘é¾™éª¨': new THREE.Vector3(0.9,0.2,-0.2),
            'æ¨ªå‘é¾™éª¨': new THREE.Vector3(1.2,0.5,0.1),
            'ä¿æ¸©å±‚': new THREE.Vector3(0.3,0,-0.7),
            'çŸ³ææŒ‚ä»¶': new THREE.Vector3(1.5,0.1,0.5),
            'çŸ³æé¢æ¿': new THREE.Vector3(2.0,0.3,0.8),
            'å¯†å°èƒ¶': new THREE.Vector3(1.8,-0.2,1.2)
        };

        function applySplit(enable) {
            if (!currentModel) return;
            layerConfig.forEach(layer => {
                const meshes = layerMeshesMap.get(layer.name) || [];
                meshes.forEach(mesh => {
                    if (enable) {
                        // ä¿å­˜åŸå§‹ä½ç½®
                        if (mesh.userData.originalPos === undefined) {
                            mesh.userData.originalPos = mesh.position.clone();
                        }
                        const offset = splitOffsets[layer.name] || new THREE.Vector3(0,0,0);
                        mesh.position.copy(mesh.userData.originalPos.clone().add(offset));
                    } else {
                        if (mesh.userData.originalPos) {
                            mesh.position.copy(mesh.userData.originalPos);
                        }
                    }
                });
            });
            isSplit = enable;
            setStatus(enable ? 'æ‹†åˆ†æ¨¡å¼' : 'ç»„è£…å¤ä½');
        }

        // ---------- åŠ è½½FBXæ¨¡å‹ ----------
        setStatus('æ­£åœ¨åŠ è½½ qiangti.FBX ...');
        const loader = new FBXLoader();
        // æ³¨æ„ï¼šä½¿ç”¨æ‚¨çš„åœ¨çº¿è·¯å¾„
        loader.load('https://kutabimvr.github.io/3DmodelV2.0/qiangti.FBX', 
            (object) => {
                setStatus('âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼Œæ­£åœ¨è§£ææ„ä»¶...');
                
                if (currentModel) scene.remove(currentModel);
                
                // é¢„å¤„ç†ï¼šç¼©æ”¾å±…ä¸­è½åœ°ä½ç§» (ä¸ä¹‹å‰é€»è¾‘ä¿ç•™)
                const box = new THREE.Box3().setFromObject(object);
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = maxDim > 0 ? 5.0 / maxDim : 1;
                object.scale.setScalar(scale);
                
                const scaledBox = new THREE.Box3().setFromObject(object);
                const center = scaledBox.getCenter(new THREE.Vector3());
                object.position.sub(center);
                
                // æŠ¬å‡åˆ°ç½‘æ ¼å¹³é¢
                const updatedBox = new THREE.Box3().setFromObject(object);
                const minY = updatedBox.min.y;
                object.position.y += -minY;
                
                // éå†ï¼Œæ ¹æ®èŠ‚ç‚¹åç§°ï¼ˆä¸­æ–‡ï¼‰åˆ†ç±»ï¼Œå¹¶è®¾ç½®æè´¨é¢œè‰²ï¼ˆå»ºè®®è‰²ï¼‰
                object.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        // ä¿å­˜åŸå§‹ä½ç½®ç”¨äºæ‹†åˆ†
                        child.userData.originalPos = child.position.clone();
                        
                        // æ ¹æ®å‘½ååŒ¹é…å±‚çº§ (å¿½ç•¥å¤§å°å†™)
                        const name = child.name;
                        let matchedLayer = null;
                        for (let layer of layerConfig) {
                            // åŒ¹é…å…³é”®è¯: æ¯”å¦‚åŸºå±‚_å¢™ä½“, é¢„åŸ‹ä»¶, é¾™éª¨_ç«–å‘ ç­‰
                            if (name.includes(layer.keyword) || name.includes(layer.keyword.replace('_','')) || 
                                (layer.name === 'ç«–å‘é¾™éª¨' && (name.includes('ç«–å‘')||name.includes('é¾™éª¨_ç«–å‘'))) ||
                                (layer.name === 'æ¨ªå‘é¾™éª¨' && (name.includes('æ¨ªå‘')||name.includes('é¾™éª¨_æ¨ªå‘'))) ) {
                                matchedLayer = layer;
                                break;
                            }
                        }
                        // è‹¥ä»æ— åŒ¹é…ï¼Œå°è¯•é€šè¿‡ä¸­æ–‡åæ¨¡ç³Šï¼ˆç”±äºå‘½åå«ä¸­æ–‡ï¼‰
                        if (!matchedLayer) {
                            for (let layer of layerConfig) {
                                if (name.includes(layer.name) || name.includes(layer.keyword)) {
                                    matchedLayer = layer;
                                    break;
                                }
                            }
                        }
                        
                        if (matchedLayer) {
                            // å­˜å…¥map
                            if (!layerMeshesMap.has(matchedLayer.name)) layerMeshesMap.set(matchedLayer.name, []);
                            layerMeshesMap.get(matchedLayer.name).push(child);
                            
                            // èµ‹äºˆå»ºè®®é¢œè‰², ä¿ç•™ç²—ç³™åº¦é‡‘å±æ„Ÿ
                            if (child.material) {
                                const mats = Array.isArray(child.material) ? child.material : [child.material];
                                mats.forEach(mat => {
                                    if (mat) {
                                        const colorHex = matchedLayer.color;
                                        mat.color = new THREE.Color(colorHex);
                                        mat.emissive = new THREE.Color(matchedLayer.emissive || '#222222');
                                        mat.emissiveIntensity = 0.1;
                                        mat.roughness = 0.65;
                                        mat.metalness = 0.2;
                                    }
                                });
                            }
                        } else {
                            // æœªåŒ¹é…çš„ç»™ä¸ªé»˜è®¤è‰²
                        }
                    }
                });

                scene.add(object);
                currentModel = object;
                
                // ç”Ÿæˆå±‚æ¬¡æŒ‰é’®
                generateLayerButtons();
                
                // é‡ç½®åŠé€æ˜ã€æ‹†åˆ†çŠ¶æ€
                resetAllOpacity();
                if (isSplit) applySplit(true); // å¦‚ä¹‹å‰æ˜¯æ‹†åˆ†çŠ¶æ€é‡æ–°åº”ç”¨
                setStatus('âœ… å°±ç»ª | å•å‡»æŒ‰é’®é«˜äº®å¹¶è¯­éŸ³');
                controls.autoRotate = true;
            },
            (progress) => {
                if (progress.lengthComputable) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    setStatus(`åŠ è½½ä¸­ ${percent}%`);
                }
            },
            (error) => {
                console.error('FBXåŠ è½½é”™è¯¯', error);
                setStatus('âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤qiangti.FBXè·¯å¾„', true);
            }
        );

        // ---------- ç”ŸæˆåŠ¨æ€æŒ‰é’® ----------
        function generateLayerButtons() {
            const container = document.getElementById('layer-buttons-container');
            container.innerHTML = '';
            layerConfig.forEach(layer => {
                const btn = document.createElement('button');
                btn.className = 'layer-btn';
                btn.innerHTML = `<span class="btn-icon">ğŸ§±</span> ${layer.name}`;
                btn.dataset.layer = layer.name;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // è¯­éŸ³è®²è§£
                    speakLayerInfo(layer.name);
                    // é«˜äº®å¤„ç†ï¼šå¦‚æœå·²ç»æ˜¯é«˜äº®åˆ™å–æ¶ˆé«˜äº®ï¼ˆé‡ç½®ï¼‰ï¼Œå¦åˆ™é«˜äº®
                    if (currentActiveLayer === layer.name) {
                        resetAllOpacity();
                        updateDescription('åŸºå±‚å¢™ä½“'); // é»˜è®¤æ˜¾ç¤ºåŸºå±‚
                    } else {
                        highlightLayer(layer.name);
                    }
                    // æŒ‰é’®æ¿€æ´»æ ·å¼åˆ‡æ¢
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    if (currentActiveLayer === layer.name) {
                        // å–æ¶ˆæ¿€æ´»çŠ¶æ€ (resetåæ— é«˜äº®)
                    } else {
                        btn.classList.add('active');
                    }
                });
                container.appendChild(btn);
            });
        }

        // é»˜è®¤æè¿°
        updateDescription('åŸºå±‚å¢™ä½“');

        // ---------- æ‹†è£…æŒ‰é’®äº‹ä»¶ ----------
        document.getElementById('btn-split').addEventListener('click', () => {
            applySplit(true);
        });
        document.getElementById('btn-assemble').addEventListener('click', () => {
            applySplit(false);
            resetAllOpacity();
        });

        // ---------- è¯•é¢˜äº¤äº’ ----------
        const options = document.querySelectorAll('.option-item');
        let selectedIndex = null;
        options.forEach((opt, idx) => {
            opt.addEventListener('click', () => {
                options.forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedIndex = idx;
                // ç®€å•åˆ¤æ–­ï¼šçŸ³ææŒ‚ä»¶ (ç´¢å¼•2)
                const feedback = document.getElementById('quiz-feedback');
                if (idx === 2) {
                    feedback.innerHTML = 'âœ… å›ç­”æ­£ç¡®ï¼çŸ³ææŒ‚ä»¶æ˜¯è¿æ¥çŸ³æä¸é¾™éª¨çš„å…³é”®å—åŠ›æ„ä»¶ã€‚';
                    feedback.style.borderLeftColor = '#4caf50';
                } else {
                    feedback.innerHTML = 'âŒ å†æƒ³æƒ³ï¼ŒæŒ‚ä»¶æ‰¿æ‹…çŸ³æè·è½½å¹¶ä¼ é€’è‡³é¾™éª¨ã€‚';
                    feedback.style.borderLeftColor = '#ff5555';
                }
            });
        });

        // ---------- è‡ªé€‚åº”çª—å£ ----------
        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // ---------- åŠ¨ç”»å¾ªç¯ ----------
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // åˆå§‹åŒ–æç¤º
        setStatus('å°±ç»ª');
    </script>
</body>
</html>
